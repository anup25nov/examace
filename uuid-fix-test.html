<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UUID Fix Test - ExamAce</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .uuid-display {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß UUID Fix Test - ExamAce</h1>
        <p>This page tests the UUID generation fix for the user_profiles table.</p>
        
        <div class="test-section">
            <h2>1. UUID Generation Test</h2>
            <p>Test the new UUID generation utility:</p>
            <button onclick="testUUIDGeneration()">üß™ Test UUID Generation</button>
            <div id="uuid-results"></div>
        </div>

        <div class="test-section">
            <h2>2. Database Schema Test</h2>
            <p>Test creating a user profile with a proper UUID:</p>
            <button onclick="testUserProfileCreation()">üë§ Test User Profile Creation</button>
            <div id="profile-results"></div>
        </div>

        <div class="test-section">
            <h2>3. OTP Integration Test</h2>
            <p>Test the complete OTP verification flow with UUID:</p>
            <button onclick="testOTPFlow()">üì± Test OTP Flow</button>
            <div id="otp-results"></div>
        </div>

        <div class="test-section">
            <h2>4. Error Comparison</h2>
            <p>Compare old vs new user ID generation:</p>
            <button onclick="compareUserIDFormats()">‚öñÔ∏è Compare Formats</button>
            <div id="comparison-results"></div>
        </div>
    </div>

    <script>
        // Mock the UUID utilities for testing
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback implementation
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function isValidUUID(uuid) {
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            return uuidRegex.test(uuid);
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultElement = document.createElement('div');
            resultElement.className = `result ${type}`;
            resultElement.textContent = message;
            element.appendChild(resultElement);
            element.scrollTop = element.scrollHeight;
        }

        function clearResults(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function testUUIDGeneration() {
            clearResults('uuid-results');
            showResult('uuid-results', 'üß™ Testing UUID Generation...', 'info');
            
            try {
                const uuids = [];
                for (let i = 0; i < 5; i++) {
                    uuids.push(generateUUID());
                }
                
                const results = {
                    generated: uuids,
                    allValid: uuids.every(isValidUUID),
                    allUnique: new Set(uuids).size === uuids.length,
                    format: 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'
                };
                
                let message = `‚úÖ UUID Generation Test Results:
Generated ${uuids.length} UUIDs:
${uuids.map((uuid, i) => `${i + 1}. ${uuid}`).join('\n')}

Validation Results:
- All Valid UUIDs: ${results.allValid}
- All Unique: ${results.allUnique}
- Expected Format: ${results.format}`;

                showResult('uuid-results', message, results.allValid && results.allUnique ? 'success' : 'error');
            } catch (error) {
                showResult('uuid-results', `‚ùå UUID Generation Test Failed: ${error.message}`, 'error');
            }
        }

        async function testUserProfileCreation() {
            clearResults('profile-results');
            showResult('profile-results', 'üë§ Testing User Profile Creation...', 'info');
            
            try {
                const testUUID = generateUUID();
                const testPhone = '7050959444';
                
                showResult('profile-results', `Generated Test UUID: ${testUUID}`, 'info');
                showResult('profile-results', `Test Phone: ${testPhone}`, 'info');
                
                // Test the database insertion
                const response = await fetch('https://talvssmwnsfotoutjlhd.supabase.co/rest/v1/user_profiles', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhbHZzc213bnNmb3RvdXRqbGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MjQ2NjMsImV4cCI6MjA3MjMwMDY2M30.kViEumcw7qxZeITgtZf91D-UVFY5PaFyXganLyh2Tok',
                        'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhbHZzc213bnNmb3RvdXRqbGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MjQ2NjMsImV4cCI6MjA3MjMwMDY2M30.kViEumcw7qxZeITgtZf91D-UVFY5PaFyXganLyh2Tok',
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        id: testUUID,
                        phone: testPhone
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('profile-results', `‚úÖ User Profile Created Successfully!`, 'success');
                    showResult('profile-results', `Created Profile:\n${JSON.stringify(data[0], null, 2)}`, 'success');
                    
                    // Clean up the test record
                    await fetch(`https://talvssmwnsfotoutjlhd.supabase.co/rest/v1/user_profiles?id=eq.${testUUID}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhbHZzc213bnNmb3RvdXRqbGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MjQ2NjMsImV4cCI6MjA3MjMwMDY2M30.kViEumcw7qxZeITgtZf91D-UVFY5PaFyXganLyh2Tok',
                            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhbHZzc213bnNmb3RvdXRqbGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MjQ2NjMsImV4cCI6MjA3MjMwMDY2M30.kViEumcw7qxZeITgtZf91D-UVFY5PaFyXganLyh2Tok'
                        }
                    });
                    showResult('profile-results', 'üßπ Test record cleaned up', 'info');
                } else {
                    const errorText = await response.text();
                    showResult('profile-results', `‚ùå User Profile Creation Failed:\nStatus: ${response.status}\nError: ${errorText}`, 'error');
                }
            } catch (error) {
                showResult('profile-results', `‚ùå Test Failed: ${error.message}`, 'error');
            }
        }

        async function testOTPFlow() {
            clearResults('otp-results');
            showResult('otp-results', 'üì± Testing OTP Flow with UUID...', 'info');
            
            try {
                const testUUID = generateUUID();
                showResult('otp-results', `Generated User ID: ${testUUID}`, 'info');
                showResult('otp-results', `UUID Valid: ${isValidUUID(testUUID)}`, 'info');
                
                // Simulate the OTP verification flow
                showResult('otp-results', '‚úÖ OTP Flow Simulation:', 'info');
                showResult('otp-results', `1. User enters phone: +917050959444`, 'info');
                showResult('otp-results', `2. OTP sent successfully`, 'info');
                showResult('otp-results', `3. User enters OTP: 537964`, 'info');
                showResult('otp-results', `4. OTP verified successfully`, 'info');
                showResult('otp-results', `5. User ID generated: ${testUUID}`, 'info');
                showResult('otp-results', `6. User profile would be created with this UUID`, 'info');
                
                showResult('otp-results', 'üéâ OTP Flow Test Complete - No UUID errors expected!', 'success');
            } catch (error) {
                showResult('otp-results', `‚ùå OTP Flow Test Failed: ${error.message}`, 'error');
            }
        }

        function compareUserIDFormats() {
            clearResults('comparison-results');
            showResult('comparison-results', '‚öñÔ∏è Comparing Old vs New User ID Formats...', 'info');
            
            try {
                // Old format (causing the error)
                const oldFormat = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // New format (fixed)
                const newFormat = generateUUID();
                
                const comparison = {
                    oldFormat: {
                        value: oldFormat,
                        length: oldFormat.length,
                        isValidUUID: isValidUUID(oldFormat),
                        wouldCauseError: !isValidUUID(oldFormat)
                    },
                    newFormat: {
                        value: newFormat,
                        length: newFormat.length,
                        isValidUUID: isValidUUID(newFormat),
                        wouldCauseError: !isValidUUID(newFormat)
                    }
                };
                
                let message = `üìä User ID Format Comparison:

OLD FORMAT (‚ùå BROKEN):
- Value: ${comparison.oldFormat.value}
- Length: ${comparison.oldFormat.length} characters
- Valid UUID: ${comparison.oldFormat.isValidUUID}
- Would Cause Error: ${comparison.oldFormat.wouldCauseError}

NEW FORMAT (‚úÖ FIXED):
- Value: ${comparison.newFormat.value}
- Length: ${comparison.newFormat.length} characters
- Valid UUID: ${comparison.newFormat.isValidUUID}
- Would Cause Error: ${comparison.newFormat.wouldCauseError}

CONCLUSION:
The old format generates strings like "${oldFormat}" which are NOT valid UUIDs.
The new format generates proper UUIDs like "${newFormat}" which ARE valid.
This fixes the "invalid input syntax for type uuid" error!`;

                showResult('comparison-results', message, 'success');
            } catch (error) {
                showResult('comparison-results', `‚ùå Comparison Failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
