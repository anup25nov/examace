<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral System Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>üîó Referral System Test Suite</h1>
    
    <div class="test-section">
        <h2>1. Database Schema Test</h2>
        <button onclick="testDatabaseSchema()">Test Schema</button>
        <div id="schemaLog" class="log hidden"></div>
    </div>

    <div class="test-section">
        <h2>2. Referral Code Creation Test</h2>
        <button onclick="testCreateReferralCode()">Create Test Referral Code</button>
        <div id="referralCodeLog" class="log hidden"></div>
    </div>

    <div class="test-section">
        <h2>3. Referral Application Test</h2>
        <button onclick="testApplyReferralCode()">Apply Referral Code</button>
        <div id="applyReferralLog" class="log hidden"></div>
    </div>

    <div class="test-section">
        <h2>4. Payment with Referral Test</h2>
        <button onclick="testPaymentWithReferral()">Test Payment Flow</button>
        <div id="paymentReferralLog" class="log hidden"></div>
    </div>

    <div class="test-section">
        <h2>5. Commission Processing Test</h2>
        <button onclick="testCommissionProcessing()">Test Commission</button>
        <div id="commissionLog" class="log hidden"></div>
    </div>

    <div class="test-section">
        <h2>6. Referral Stats Test</h2>
        <button onclick="testReferralStats()">Get Referral Stats</button>
        <div id="statsLog" class="log hidden"></div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://talvssmwnsfotoutjlhd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRhbHZzc213bnNmb3RvdXRqbGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MjQ2NjMsImV4cCI6MjA3MjMwMDY2M30.kViEumcw7qxZeITgtZf91D-UVFY5PaFyXganLyh2Tok';
        
        // Test data
        let testReferralCode = '';
        let testUserId = 'fa55b327-1200-47a8-aa33-9f8a56df50ec'; // Your test user ID
        let testReferrerId = '';

        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            logElement.classList.remove('hidden');
            const timestamp = new Date().toISOString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        async function testDatabaseSchema() {
            log('schemaLog', 'Testing database schema for referral system...');
            
            try {
                // Test if referral_transactions table has required columns
                const response = await fetch(`${SUPABASE_URL}/rest/v1/referral_transactions?select=*&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    log('schemaLog', '‚úÖ referral_transactions table accessible', 'success');
                    
                    // Check if we can query the table structure
                    const data = await response.json();
                    if (data.length > 0) {
                        const columns = Object.keys(data[0]);
                        log('schemaLog', `üìã Available columns: ${columns.join(', ')}`, 'info');
                        
                        const requiredColumns = ['referral_code', 'commission_amount', 'commission_status', 'membership_purchased', 'payment_id'];
                        const missingColumns = requiredColumns.filter(col => !columns.includes(col));
                        
                        if (missingColumns.length === 0) {
                            log('schemaLog', '‚úÖ All required columns present', 'success');
                        } else {
                            log('schemaLog', `‚ùå Missing columns: ${missingColumns.join(', ')}`, 'error');
                        }
                    } else {
                        log('schemaLog', '‚ö†Ô∏è Table is empty, cannot verify column structure', 'warning');
                    }
                } else {
                    log('schemaLog', `‚ùå Failed to access referral_transactions: ${response.status}`, 'error');
                }

                // Test referral_codes table
                const codesResponse = await fetch(`${SUPABASE_URL}/rest/v1/referral_codes?select=*&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (codesResponse.ok) {
                    log('schemaLog', '‚úÖ referral_codes table accessible', 'success');
                } else {
                    log('schemaLog', `‚ùå Failed to access referral_codes: ${codesResponse.status}`, 'error');
                }

            } catch (error) {
                log('schemaLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testCreateReferralCode() {
            log('referralCodeLog', 'Testing referral code creation...');
            
            try {
                // Test RPC function for creating referral code
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/create_user_referral_code`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_user_uuid: testUserId,
                        p_custom_code: 'TEST' + Date.now()
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('RPC Response:', result);
                    if (result.success && result.referral_code) {
                        testReferralCode = result.referral_code;
                        testReferrerId = testUserId;
                        log('referralCodeLog', `‚úÖ Referral code created: ${testReferralCode}`, 'success');
                    } else {
                        log('referralCodeLog', `‚ùå Failed to create referral code: ${result.error || result.message || 'Unknown error'}`, 'error');
                        // Fallback: use a hardcoded test code
                        testReferralCode = 'TEST123';
                        testReferrerId = testUserId;
                        log('referralCodeLog', `‚ö†Ô∏è Using fallback test code: ${testReferralCode}`, 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log('referralCodeLog', `‚ùå RPC call failed: ${response.status} - ${errorText}`, 'error');
                    // Fallback: use a hardcoded test code
                    testReferralCode = 'TEST123';
                    testReferrerId = testUserId;
                    log('referralCodeLog', `‚ö†Ô∏è Using fallback test code: ${testReferralCode}`, 'warning');
                }

            } catch (error) {
                log('referralCodeLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testApplyReferralCode() {
            log('applyReferralLog', 'Testing referral code application...');
            
            if (!testReferralCode) {
                log('applyReferralLog', '‚ùå No referral code available. Create one first.', 'error');
                return;
            }

            // Create a different user ID for the referred user (can't refer yourself)
            const referredUserId = '00000000-0000-0000-0000-000000000001'; // Different from testUserId

            try {
                // Test applying referral code
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/apply_referral_code`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_user_id: referredUserId, // Use different user ID
                        p_referral_code: testReferralCode
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Apply Referral RPC Response:', result);
                    if (result && result.length > 0 && result[0].success) {
                        log('applyReferralLog', `‚úÖ Referral code applied successfully`, 'success');
                        log('applyReferralLog', `üìã Message: ${result[0].message}`, 'info');
                    } else {
                        const errorMsg = result && result.length > 0 ? result[0].message : (result.message || result.error || 'Unknown error');
                        log('applyReferralLog', `‚ùå Failed to apply referral code: ${errorMsg}`, 'error');
                        console.log('Full error result:', result);
                    }
                } else {
                    const errorText = await response.text();
                    log('applyReferralLog', `‚ùå RPC call failed: ${response.status} - ${errorText}`, 'error');
                }

            } catch (error) {
                log('applyReferralLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testPaymentWithReferral() {
            log('paymentReferralLog', 'Testing payment flow with referral...');
            
            try {
                // Create a test payment
                const paymentData = {
                    payment_id: `PAY_REF_TEST_${Date.now()}`,
                    user_id: testUserId,
                    plan_id: 'pro',
                    plan_name: 'Pro Plan',
                    amount: 99.00,
                    currency: 'INR',
                    payment_method: 'razorpay',
                    status: 'pending',
                    razorpay_order_id: `order_ref_test_${Date.now()}`,
                    payment_method: 'razorpay'
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/payments`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(paymentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    log('paymentReferralLog', `‚úÖ Test payment created: ${result[0].id}`, 'success');
                    
                    // Now test the commission processing RPC
                    await testCommissionProcessing(result[0].id);
                } else {
                    const errorText = await response.text();
                    log('paymentReferralLog', `‚ùå Failed to create payment: ${response.status} - ${errorText}`, 'error');
                }

            } catch (error) {
                log('paymentReferralLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testCommissionProcessing(paymentId = null) {
            log('commissionLog', 'Testing commission processing...');
            
            if (!paymentId) {
                // Get the latest payment
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/payments?select=id&user_id=eq.${testUserId}&order=created_at.desc&limit=1`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.length > 0) {
                            paymentId = data[0].id;
                        }
                    }
                } catch (error) {
                    log('commissionLog', `‚ùå Error getting payment ID: ${error.message}`, 'error');
                    return;
                }
            }

            if (!paymentId) {
                log('commissionLog', '‚ùå No payment ID available for testing', 'error');
                return;
            }

            try {
                // Test the commission processing RPC
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/process_referral_commission`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_payment_id: paymentId,
                        p_referred_user_id: '00000000-0000-0000-0000-000000000001', // Use different user ID
                        p_payment_amount: 99.00,
                        p_referral_code: testReferralCode || 'TEST123'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        log('commissionLog', `‚úÖ Commission processed successfully`, 'success');
                        log('commissionLog', `üí∞ Commission amount: ‚Çπ${result.commission_amount}`, 'info');
                        log('commissionLog', `üÜî Transaction ID: ${result.transaction_id}`, 'info');
                    } else {
                        log('commissionLog', `‚ùå Commission processing failed: ${result.error}`, 'error');
                    }
                } else {
                    const errorText = await response.text();
                    log('commissionLog', `‚ùå RPC call failed: ${response.status} - ${errorText}`, 'error');
                }

            } catch (error) {
                log('commissionLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testReferralStats() {
            log('statsLog', 'Testing referral stats...');
            
            try {
                // Test getting referral stats
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/get_referral_stats`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_user_id: testUserId
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('statsLog', `‚úÖ Referral stats retrieved successfully`, 'success');
                    log('statsLog', `üìä Total referrals: ${result.total_referrals}`, 'info');
                    log('statsLog', `‚úÖ Completed referrals: ${result.completed_referrals}`, 'info');
                    log('statsLog', `üí∞ Total earnings: ‚Çπ${result.total_earnings}`, 'info');
                    log('statsLog', `‚è≥ Pending earnings: ‚Çπ${result.pending_earnings}`, 'info');
                    log('statsLog', `üí≥ Paid earnings: ‚Çπ${result.paid_earnings}`, 'info');
                } else {
                    const errorText = await response.text();
                    log('statsLog', `‚ùå RPC call failed: ${response.status} - ${errorText}`, 'error');
                }

            } catch (error) {
                log('statsLog', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        // Auto-run schema test on load
        window.onload = function() {
            testDatabaseSchema();
        };
    </script>
</body>
</html>
