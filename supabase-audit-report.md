# üîç Supabase Functions & Triggers Audit Report

## üìä Executive Summary

- **Edge Functions**: 2/6 used (33% utilization)
- **RPC Functions**: 34/36 used (94% utilization) 
- **Tables**: 2 tables actively accessed
- **Unused Functions**: 4 Edge Functions, 2 RPC Functions

---

## üöÄ Edge Functions Analysis

### ‚úÖ **USED Edge Functions** (2/6)

| Function | Usage Count | Files |
|----------|-------------|-------|
| `verify_razorpay_payment` | 2 calls | `UnifiedPaymentModal.tsx:328`, `razorpayPaymentService.ts:108` |
| `create_razorpay_order` | 1 call | `razorpayPaymentService.ts:42` |

### ‚ùå **UNUSED Edge Functions** (4/6)

| Function | Status | Recommendation |
|----------|--------|----------------|
| `debug-signature` | Has index.ts | **REMOVE** - Debug function |
| `get-test-questions` | Has index.ts | **REMOVE** - Not used anywhere |
| `razorpay-webhook` | Has index.ts | **KEEP** - Webhook for production |
| `test-cors` | Missing index.ts | **REMOVE** - Incomplete function |

---

## üîß RPC Functions Analysis

### ‚úÖ **USED RPC Functions** (34/36)

**High Usage Functions:**
- `get_comprehensive_referral_stats` (3 calls)
- `get_referral_network_detailed` (3 calls)
- `is_admin` (2 calls)
- `get_user_referral_earnings` (2 calls)
- `get_user_performance_stats` (2 calls)
- `update_exam_stats_properly` (2 calls)

**Single Use Functions:**
- `get_pending_question_reports`
- `get_pending_withdrawal_requests`
- `resolve_question_report`
- `process_withdrawal_request_with_message`
- `get_user_messages`
- `mark_message_as_read`
- `can_make_withdrawal_request`
- `get_all_payments`
- `admin_verify_payment`
- `validate_and_apply_referral_code`
- `get_bulk_test_completions`
- `get_all_test_completions_for_exam`
- `get_test_completions_by_ids`
- `process_membership_commission`
- `handle_membership_refund`
- `get_membership_plans`
- `get_membership_plan`
- `get_plan_features`
- `get_user_membership_status`
- `attempt_use_mock`
- `get_comprehensive_stats`
- `log_payment_audit`
- `get_test_rank_and_highest_score`
- `get_test_leaderboard`
- `update_all_test_ranks`
- `upsert_test_completion_simple`
- `update_user_streak`
- `process_referral_commission`

### ‚ùå **UNUSED RPC Functions** (2/36)

| Function | Recommendation |
|----------|----------------|
| `calculate_exam_ranks` | **REMOVE** - Not used anywhere |
| `Args` | **INVESTIGATE** - This might be a parsing error |

---

## üìä Table Operations Analysis

### ‚úÖ **USED Tables** (2)

| Table | Operations | Files |
|-------|------------|-------|
| `user_profiles` | 1 operation | Various files |
| `payments` | 1 operation | Payment services |

---

## üóëÔ∏è Cleanup Recommendations

### **High Priority - Remove These:**

1. **Edge Functions:**
   ```bash
   rm -rf supabase/functions/debug-signature/
   rm -rf supabase/functions/get-test-questions/
   rm -rf supabase/functions/test-cors/
   ```

2. **RPC Functions:**
   - `calculate_exam_ranks` - Remove from database
   - `Args` - Investigate if this is a parsing error

### **Medium Priority - Investigate:**

1. **`razorpay-webhook`** - Keep for production webhook handling
2. **`Args`** - Check if this is a real function or parsing error

---

## üîç Table Triggers Analysis

To check for table triggers, you can run this SQL query in your Supabase SQL editor:

```sql
-- Check for all triggers in the database
SELECT 
    schemaname,
    tablename,
    triggername,
    triggerdef
FROM pg_trigger t
JOIN pg_class c ON t.tgrelid = c.oid
JOIN pg_namespace n ON c.relnamespace = n.oid
WHERE n.nspname = 'public'
ORDER BY tablename, triggername;
```

---

## üìà Performance Impact

### **Unused Functions Impact:**
- **Edge Functions**: 4 unused functions consuming storage
- **RPC Functions**: 2 unused functions in database schema
- **Maintenance**: Unused code increases maintenance burden

### **Optimization Opportunities:**
1. Remove unused Edge Functions to reduce deployment size
2. Clean up unused RPC Functions from database
3. Consider consolidating similar RPC functions

---

## üõ†Ô∏è Next Steps

1. **Immediate Actions:**
   - Remove unused Edge Functions
   - Remove unused RPC Functions from database
   - Verify `Args` function status

2. **Database Cleanup:**
   - Run trigger analysis query
   - Document all active triggers
   - Remove unused triggers if any

3. **Monitoring:**
   - Set up usage monitoring for remaining functions
   - Regular audits to prevent accumulation of unused code

---

## üìù Notes

- The audit script can be run regularly to track function usage
- Consider adding function usage metrics to your monitoring
- Document the purpose of each remaining function
- Keep the `razorpay-webhook` function for production webhook handling

---

*Generated by Supabase Audit Script v1.0*
